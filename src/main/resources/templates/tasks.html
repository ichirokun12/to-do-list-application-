<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaskFlow Pro - Interactive Task Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Confetti Library -->
    <link rel="stylesheet" href="tasks.css">
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
    <!-- Sortable.js for drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>
<body data-theme="light">
<!-- Custom Background -->
<div class="custom-background" id="customBackground"></div>
<div class="background-overlay" id="backgroundOverlay"></div>

<!-- Interactive Toolbar -->
<div class="interactive-toolbar">
    <button class="toolbar-btn" onclick="toggleTheme()" id="themeToggle" aria-label="Toggle theme">
        <i class="fas fa-moon" id="theme-icon"></i>
        <span id="theme-text">Dark</span>
    </button>
    <button class="toolbar-btn" onclick="toggleBackgroundPanel()" id="backgroundToggle" aria-label="Background settings">
        <i class="fas fa-image"></i>
        <span>Background</span>
    </button>
    <button class="toolbar-btn" onclick="toggleTimer()" id="timerToggle" aria-label="Toggle timer">
        <i class="fas fa-clock"></i>
        <span>Timer</span>
    </button>
    <button class="toolbar-btn" onclick="showShortcuts()" aria-label="Show shortcuts">
        <i class="fas fa-keyboard"></i>
        <span>Shortcuts</span>
    </button>
    <button class="toolbar-btn" onclick="exportTasks()" aria-label="Export tasks">
        <i class="fas fa-download"></i>
        <span>Export</span>
    </button>
</div>

<!-- Background Control Panel -->
<div class="background-panel" id="backgroundPanel">
    <div class="panel-header">
        <h3 class="panel-title">
            <i class="fas fa-palette"></i>
            Background Settings
        </h3>
        <button class="close-panel" onclick="toggleBackgroundPanel()" aria-label="Close panel">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- File Upload Section -->
    <div class="upload-section">
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="upload-text">Drop image here or click to browse</div>
            <div class="upload-hint">PNG, JPG, GIF up to 5MB</div>
            <input type="file" id="backgroundFileInput" accept="image/*">
        </div>

        <!-- Background Preview -->
        <div class="background-preview" id="backgroundPreview">
            <div class="preview-overlay">
                <button class="preview-btn" onclick="applyBackground()">
                    <i class="fas fa-check"></i> Apply
                </button>
                <button class="preview-btn" onclick="clearPreview()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Background Controls -->
    <div class="control-group">
        <label class="control-label">Background Opacity</label>
        <div class="slider-container">
            <input type="range" class="slider" id="opacitySlider" min="0.3" max="1" step="0.1" value="0.8">
            <span class="slider-value" id="opacityValue">80%</span>
        </div>

        <!-- Opacity Presets -->
        <div class="opacity-presets">
            <button class="opacity-preset" data-opacity="0.5" onclick="setOpacityPreset(0.5)">Subtle</button>
            <button class="opacity-preset active" data-opacity="0.8" onclick="setOpacityPreset(0.8)">Clear</button>
            <button class="opacity-preset" data-opacity="1.0" onclick="setOpacityPreset(1.0)">Full</button>
        </div>
    </div>

    <div class="control-group">
        <label class="control-label">Background Position</label>
        <div class="position-grid">
            <button class="position-btn" data-position="left top">
                <i class="fas fa-arrow-up"></i>
            </button>
            <button class="position-btn" data-position="center top">
                <i class="fas fa-arrow-up"></i>
            </button>
            <button class="position-btn" data-position="right top">
                <i class="fas fa-arrow-up"></i>
            </button>
            <button class="position-btn" data-position="left center">
                <i class="fas fa-arrow-left"></i>
            </button>
            <button class="position-btn active" data-position="center center">
                <i class="fas fa-dot-circle"></i>
            </button>
            <button class="position-btn" data-position="right center">
                <i class="fas fa-arrow-right"></i>
            </button>
            <button class="position-btn" data-position="left bottom">
                <i class="fas fa-arrow-down"></i>
            </button>
            <button class="position-btn" data-position="center bottom">
                <i class="fas fa-arrow-down"></i>
            </button>
            <button class="position-btn" data-position="right bottom">
                <i class="fas fa-arrow-down"></i>
            </button>
        </div>
    </div>

    <div class="control-group">
        <label class="control-label">Background Size</label>
        <div class="position-grid" style="grid-template-columns: repeat(2, 1fr);">
            <button class="position-btn active" data-size="cover">Cover</button>
            <button class="position-btn" data-size="contain">Contain</button>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button class="action-btn secondary" onclick="resetBackground()">
            <i class="fas fa-undo"></i> Reset
        </button>
        <button class="action-btn primary" onclick="saveBackground()">
            <i class="fas fa-save"></i> Save
        </button>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Context Menu -->
<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="editTaskInline()">
        <i class="fas fa-edit"></i>
        <span>Edit Task</span>
    </div>
    <div class="context-menu-item" onclick="duplicateTask()">
        <i class="fas fa-copy"></i>
        <span>Duplicate</span>
    </div>
    <div class="context-menu-item" onclick="togglePriority()">
        <i class="fas fa-flag"></i>
        <span>Change Priority</span>
    </div>
    <div class="context-menu-item" onclick="startTaskTimer()">
        <i class="fas fa-play"></i>
        <span>Start Timer</span>
    </div>
    <div class="context-menu-item danger" onclick="deleteTaskFromContext()">
        <i class="fas fa-trash"></i>
        <span>Delete Task</span>
    </div>
</div>

<!-- Timer Widget -->
<div class="timer-widget" id="timerWidget">
    <div class="timer-display" id="timerDisplay">25:00</div>
    <div class="timer-controls">
        <button class="timer-btn" onclick="startTimer()">
            <i class="fas fa-play"></i>
        </button>
        <button class="timer-btn" onclick="pauseTimer()">
            <i class="fas fa-pause"></i>
        </button>
        <button class="timer-btn" onclick="resetTimer()">
            <i class="fas fa-stop"></i>
        </button>
    </div>
    <div style="text-align: center; margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
        Pomodoro Timer
    </div>
</div>

<!-- Keyboard Shortcuts Help -->
<div class="shortcuts-help" id="shortcutsHelp">
    <div class="shortcuts-title">⌨️ Keyboard Shortcuts</div>
    <div class="shortcut-row">
        <div class="shortcut-keys">
            <span class="shortcut-key">Ctrl</span>
            <span class="shortcut-key">K</span>
        </div>
        <span class="shortcut-desc">Focus search</span>
    </div>
    <div class="shortcut-row">
        <div class="shortcut-keys">
            <span class="shortcut-key">Ctrl</span>
            <span class="shortcut-key">N</span>
        </div>
        <span class="shortcut-desc">New task</span>
    </div>
    <div class="shortcut-row">
        <div class="shortcut-keys">
            <span class="shortcut-key">Ctrl</span>
            <span class="shortcut-key">T</span>
        </div>
        <span class="shortcut-desc">Toggle timer</span>
    </div>
    <div class="shortcut-row">
        <div class="shortcut-keys">
            <span class="shortcut-key">Ctrl</span>
            <span class="shortcut-key">D</span>
        </div>
        <span class="shortcut-desc">Toggle dark mode</span>
    </div>
    <div class="shortcut-row">
        <div class="shortcut-keys">
            <span class="shortcut-key">Ctrl</span>
            <span class="shortcut-key">B</span>
        </div>
        <span class="shortcut-desc">Background settings</span>
    </div>
    <div class="shortcut-row">
        <div class="shortcut-keys">
            <span class="shortcut-key">Esc</span>
        </div>
        <span class="shortcut-desc">Close dialogs</span>
    </div>
    <div class="shortcut-row">
        <div class="shortcut-keys">
            <span class="shortcut-key">?</span>
        </div>
        <span class="shortcut-desc">Show shortcuts</span>
    </div>
    <div style="text-align: center; margin-top: 16px;">
        <button class="timer-btn" onclick="hideShortcuts()">Close</button>
    </div>
</div>

<div class="container">
    <header class="header">
        <h1>TaskFlow Pro</h1>
        <p>Interactive task management with vivid custom backgrounds and smart features</p>
    </header>

    <main class="main-content">
        <section class="form-section">
            <h2>Add New Task</h2>
            <!-- FIXED: Correct Thymeleaf form action -->
            <form th:action="@{/tasks/form/add}" method="POST" onsubmit="handleFormSubmit(event)" id="taskForm">
                <div class="form-group">
                    <input type="text" name="task" id="taskInput" placeholder="What needs to be done?" required />
                </div>
                <div class="form-group">
                    <select name="status" required>
                        <option value="">Select status</option>
                        <option value="not done">Not Done</option>
                        <option value="partially done">Partially Done</option>
                        <option value="done">Done</option>
                    </select>
                </div>
                <div class="form-group">
                    <select name="priority" required>
                        <option value="">Select priority</option>
                        <option value="low">Low Priority</option>
                        <option value="medium">Medium Priority</option>
                        <option value="high">High Priority</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="time" name="startTime" placeholder="Start time (optional)" />
                </div>
                <div class="form-group">
                    <input type="time" name="endTime" placeholder="End time (optional)" />
                </div>
                <div class="form-group">
                    <input type="date" name="startDate" placeholder="Start date (optional)" />
                </div>
                <div class="form-group">
                    <input type="date" name="endDate" placeholder="End date (optional)" />
                </div>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-plus"></i>
                    Add Task
                </button>
            </form>
        </section>

        <section class="tasks-section">
            <!-- Search and Filter -->
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-box" id="searchBox" placeholder="Search tasks..." />
                <div class="search-results-info" id="searchResults"></div>
            </div>

            <div class="filter-container">
                <button class="filter-btn active" data-filter="all">
                    <i class="fas fa-list"></i> All Tasks
                </button>
                <button class="filter-btn" data-filter="done">
                    <i class="fas fa-check"></i> Completed
                </button>
                <button class="filter-btn" data-filter="not done">
                    <i class="fas fa-times"></i> Pending
                </button>
                <button class="filter-btn" data-filter="high">
                    <i class="fas fa-exclamation"></i> High Priority
                </button>
            </div>

            <!-- Task Statistics -->
            <div class="task-stats">
                <div class="stat-card" onclick="filterTasks('all')">
                    <div class="stat-number" th:text="${tasksCount ?: 0}" id="totalTasks">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-card" onclick="filterTasks('done')">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card" onclick="filterTasks('not done')">
                    <div class="stat-number" id="pendingTasks">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completionRate">0%</div>
                    <div class="stat-label">Completion</div>
                </div>
            </div>

            <div class="section-header">
                <h2 class="section-title">Your Tasks</h2>
                <span class="task-count" th:text="${tasksCount ?: 0} + ' tasks'" id="visibleTaskCount">0 tasks</span>
            </div>

            <!-- FIXED: Proper empty state condition -->
            <div th:if="${tasks == null or #lists.isEmpty(tasks)}" class="empty-state" id="emptyState">
                <div class="empty-state-icon">✨</div>
                <h3>No tasks yet</h3>
                <p>Create your first task to get started on your productivity journey</p>
            </div>

            <!-- FIXED: Sortable Task List with proper Thymeleaf -->
            <div class="tasks-list" id="tasksList" th:if="${tasks != null and not #lists.isEmpty(tasks)}">
                <div th:each="task, iterStat : ${tasks}"
                     class="task-card"
                     th:data-task-id="${task.taskId}"
                     th:data-priority="${task.priority != null ? task.priority.toLowerCase() : 'medium'}"
                     th:data-status="${task.status != null ? task.status.toLowerCase() : 'not-done'}"
                     oncontextmenu="showContextMenu(event, this)"
                     ondblclick="editTaskInline(this)">

                    <div class="task-header">
                        <h3 class="task-title" th:text="${task.task ?: 'Untitled Task'}">Task title</h3>
                        <div class="task-actions">
                            <!-- Timer button -->
                            <button type="button" class="btn btn-timer" onclick="startTaskTimer(this)"
                                    aria-label="Start timer for task">
                                <i class="fas fa-play"></i>
                                Timer
                            </button>

                            <!-- Done button -->
                            <form th:action="@{'/tasks/markDone/' + ${task.taskId}}" method="post"
                                  style="display: inline-block;"
                                  onsubmit="handleMarkDone(event, this)">
                                <button type="submit" class="btn btn-done"
                                        th:disabled="${task.status != null and task.status.toLowerCase() == 'done'}"
                                        aria-label="Mark task as done">
                                    <i class="fas fa-check"></i>
                                    Done
                                </button>
                            </form>

                            <!-- Delete button -->
                            <form th:action="@{'/tasks/delete/' + ${task.taskId}}" method="post"
                                  style="display: inline-block;"
                                  onsubmit="return handleDelete(event, this)">
                                <button type="submit" class="btn btn-delete"
                                        aria-label="Delete task">
                                    <i class="fas fa-trash"></i>
                                    Delete
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Progress bar -->
                    <div class="progress-bar">
                        <div class="progress-fill"
                             th:style="'width: ' + ${
                                     (task.status != null and task.status.toLowerCase() == 'done') ? '100' :
                                     ((task.status != null and task.status.toLowerCase() == 'partially done') ? '50' : '0')
                                 } + '%'"></div>
                    </div>

                    <div class="task-meta">
                        <div class="task-meta-item">
                            <span class="task-meta-label">Status:</span>
                            <span class="task-meta-value status-badge"
                                  th:text="${task.status ?: 'Not Done'}"
                                  th:class="'task-meta-value status-badge status-' + ${task.status != null ? task.status.toLowerCase().replace(' ', '-') : 'not-done'}">Pending</span>
                        </div>
                        <div class="task-meta-item">
                            <span class="task-meta-label">Priority:</span>
                            <span class="task-meta-value priority-badge"
                                  th:text="${task.priority ?: 'Medium'}"
                                  th:class="'task-meta-value priority-badge priority-' + ${task.priority != null ? task.priority.toLowerCase() : 'medium'}">Normal</span>
                        </div>
                        <div class="task-meta-item" th:if="${task.startTime != null and not #strings.isEmpty(task.startTime)}">
                            <span class="task-meta-label">Start:</span>
                            <span class="task-meta-value" th:text="${task.startTime}">--:--</span>
                        </div>
                        <div class="task-meta-item" th:if="${task.endTime != null and not #strings.isEmpty(task.endTime)}">
                            <span class="task-meta-label">End:</span>
                            <span class="task-meta-value" th:text="${task.endTime}">--:--</span>
                        </div>
                        <div class="task-meta-item" th:if="${task.startDate != null and not #strings.isEmpty(task.startDate)}">
                            <span class="task-meta-label">From:</span>
                            <span class="task-meta-value" th:text="${task.startDate}">--/--/----</span>
                        </div>
                        <div class="task-meta-item" th:if="${task.endDate != null and not #strings.isEmpty(task.endDate)}">
                            <span class="task-meta-label">Until:</span>
                            <span class="task-meta-value" th:text="${task.endDate}">--/--/----</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<script src="tasks.js"></script>
</body>
</html>